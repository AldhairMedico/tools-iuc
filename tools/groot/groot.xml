<tool id="groot_align" name="Groot align" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>reads to references and weight variation graphs</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
ln -s '$fastq' 'input.fastq' &&
#set $extension = str($fastq.ext)
ln -s -f '${fastq}' 'input.${extension}' &&
groot index
    --msaDir '$groot_db_select.fields.path'
    --indexDir 'grootIndex'
    --windowSize $windowSize
    --kmerSize $kmerSize
    --maxK $maxK
    --maxSketchSpan $maxSketchSpan
    --numPart $numPart
    --sketchSize $sketchSize
&&

groot align
    --fastq 'input.${extension}'
    --indexDir 'grootIndex'
    --contThresh $contThresh
    --minKmerCov $minKmerCov
    --log $log
    $noAlign
    --processors "\${GALAXY_SLOTS:-1}"

    | groot report 
    #if $report.arg_report.criteria == 'cutoff'
    --covCutoff $report.arg_report.covCutoff
    #else
    --lowCov
    #end if
    > '$report_out'

]]></command>
    <inputs>
        <param argument="--fastq" type="data" format="fastq,fastqsanger,fastq.gz,fastqsanger.gz" label="FASTQ file(s) to align"/>
        <section name="index" title="Index">
            <param name="groot_db_select" type="select" label="Groot database">
                <options from_data_table="groot_database">
                    <validator message="No groot database is available" type="no_options"/>
                </options>
            </param>
            <param argument="--windowSize" type="integer" min="0" value="100" label="Size of window to sketch graph traversals" />
            <param argument="--kmerSize" type="integer" min="0" value="31" label="Size of k-mer" />
            <param argument="--maxK" type="integer" min="0" value="40" label="maxK in the LSH Ensemble" />
            <param argument="--maxSketchSpan" type="integer" min="0" value="4" label="Maximum number of identical neighbouring sketches permitted in any graph traversal" />
            <param argument="--numPart" type="integer" min="0" value="8" label="Number of partitions in the LSH Ensemble" />
            <param argument="--sketchSize" type="integer" min="0" value="21" label="Size of MinHash sketch" />
        </section>
        <section name="align" title="Align">
            <param argument="--contThresh" type="float" min="0" max="1.0" value="0.99" label="Containment threshold for the LSH ensemble" />
            <param argument="--minKmerCov" type="integer" min="0" value="1" label="Minimum number of k-mers covering each base of a graph segment" />
            <param argument="--noAlign" type="boolean" truevalue="" falsevalue="--noAlign" label="Perform exact alignment?" 
                help="If not, graphs will still be weighted using approximate read mappings"/>
        </section>
        <section name="report" title="Report">
            <conditional name="arg_report">
                <param argument="criteria" type="select" label="Criteria for reporting ARGs">
                    <option value="cutoff" selected="true">Use coverage cutoff for reporting ARGs (--covCutoff)</option>
                    <option value="lowCov">Report ARGs which don't have 5' or 3' coverage (--lowCov)</option>
                </param>
                <when value="cutoff">
                    <param argument="--covCutoff" type="float" min="0" max="1.0" value="0.97" label="Coverage cutoff for reporting ARGs" />
                </when>
                <when value="lowCov"/>
            </conditional>
        </section>
    </inputs>
    <outputs>
        <data name="log" format="txt" label="${tool.name} on ${on_string}: Log"/>
        <data name="report_out" format="tabular" label="${tool.name} on ${on_string}: Report"/>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="fastq" value="bla-b7-150bp-5x.fq" ftype="fastq"/>
            <section name="index">
                <param name="groot_db_select" value="resfinder.90" />
                <param name="windowSize" value="150"/>
                <param name="kmerSize" value="31"/>
                <param name="maxK" value="20"/>
                <param name="maxSketchSpan" value="30"/>
                <param name="numPart" value="8"/>
                <param name="sketchSize" value="20"/>
            </section>
            <section name="align">
                <param name="contThresh" value="0.99"/>
                <param name="minKmerCov" value="1" />
                <param name="noAlign" value=""/>
            </section>
            <section name="report">
                <conditional name="arg_report">
                    <param name="criteria" value="cutoff" />
                    <param name="covCutoff" value="0.97" />
                </conditional>
            </section>
            <output name="report_out" ftype="tabular">
                <assert_contents>
                    <has_text text="blaB-7_1_AF189304"/>
                    <has_n_lines n="1"/>
                    <has_n_columns n="4"/>
                </assert_contents>
            </output>
            <output name="log" ftype="txt">
                <assert_contents>
                    <has_text text="version"/>
                    <has_text text="1.1.2"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="2">
            <param name="fastq" value="argannot-150bp-10000-reads.fq.gz" ftype="fastq.gz"/>
            <section name="index">
                <param name="groot_db_select" value="arg-annot.90" />
                <param name="windowSize" value="150"/>
                <param name="kmerSize" value="41"/>
                <param name="maxK" value="4"/>
                <param name="maxSketchSpan" value="30"/>
                <param name="numPart" value="8"/>
                <param name="sketchSize" value="21"/>
            </section>
            <section name="align">
                <param name="contThresh" value="0.99"/>
                <param name="minKmerCov" value="1" />
                <param name="noAlign" value=""/>
            </section>
            <section name="report">
                <conditional name="arg_report">
                    <param name="criteria" value="cutoff" />
                    <param name="covCutoff" value="0.97" />
                </conditional>
            </section>
            <output name="report_out" ftype="tabular">
                <assert_contents>
                    <has_text text="argannot~~~(Bla)VIM-12~~~DQ143913:1775-2575"/>
                    <has_text text="argannot~~~(Bla)VIM-2~~~AY884050:551-1351"/>
                    <has_n_lines n="14"/>
                    <has_n_columns n="4"/>
                </assert_contents>
            </output>
            <output name="log" ftype="txt">
                <assert_contents>
                    <has_text text="version"/>
                    <has_text text="1.1.2"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

@HELP@

The align subcommand is used to align reads against the indexed variation graphs. 

**Output**

The output alignment is essentially the ARG classified reads (which may be useful) and can then be used to report full-length ARGs (using the report subcommand)
    ]]></help>
    <expand macro="citations"/>
</tool>