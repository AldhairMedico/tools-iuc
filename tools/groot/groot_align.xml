<tool id="groot_align" name="Groot align" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>reads to references and weight variation graphs</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
ln -s '$fastq' 'input.fastq' &&

groot index
    --msaDir '$groot_db_select.fields.path'
    --indexDir 'grootIndex'
    --windowSize $windowSize
    --kmerSize $kmerSize
    --maxK $maxK
    --maxSketchSpan $maxSketchSpan
    --numPart $numPart
    --sketchSize $sketchSize
&&

groot align
    --fastq 'input.fastq'
    --indexDir 'grootIndex'
    --contThresh $contThresh
    --minKmerCov $minKmerCov
    --log $log
    $noAlign
    --processors "\${GALAXY_SLOTS:-1}"
    > 'output.bam'

]]></command>
    <inputs>
        <param argument="--fastq" type="data" format="fastq,fastqsanger" label="FASTQ file(s) to align"/>
        <section name="index" title="Index">
            <param name="groot_db_select" type="select" label="Groot database">
                <options from_data_table="groot_database">
                    <validator message="No groot database is available" type="no_options"/>
                </options>
            </param>
            <param argument="--windowSize" type="integer" min="0" value="100" label="Size of window to sketch graph traversals" />
            <param argument="--kmerSize" type="integer" min="0" value="31" label="Size of k-mer" />
            <param argument="--maxK" type="integer" min="0" value="40" label="maxK in the LSH Ensemble" />
            <param argument="--maxSketchSpan" type="integer" min="0" value="4" label="Maximum number of identical neighbouring sketches permitted in any graph traversal" />
            <param argument="--numPart" type="integer" min="0" value="8" label="Number of partitions in the LSH Ensemble" />
            <param argument="--sketchSize" type="integer" min="0" value="21" label="Size of MinHash sketch" />
        </section>
        <section name="align" title="Align">
            <param argument="--contThresh" type="float" min="0" max="1.0" value="0.99" label="Containment threshold for the LSH ensemble" />
            <param argument="--minKmerCov" type="integer" min="0" value="1" label="Minimum number of k-mers covering each base of a graph segment" />
            <param argument="--noAlign" type="boolean" truevalue="" falsevalue="--noAlign" label="Perform exact alignment?" 
                help="If not, graphs will still be weighted using approximate read mappings"/>
        </section>
    </inputs>
    <outputs>
        <data name="output" format="bam" from_work_dir="output.bam" label="${tool.name} on ${on_string}: Alignment"/>
        <data name="log" format="txt" label="${tool.name} on ${on_string}: Log"/>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="fastq" value="bla-b7-150bp-5x.fq"/>
            <section name="index">
                <param name="groot_db_select" value="resfinder.90" />
                <param name="windowSize" value="150"/>
                <param name="kmerSize" value="31"/>
                <param name="maxK" value="20"/>
                <param name="maxSketchSpan" value="30"/>
                <param name="numPart" value="8"/>
                <param name="sketchSize" value="20"/>
            </section>
            <section name="align">
                <param name="contThresh" value="0.99"/>
                <param name="minKmerCov" value="1" />
                <param name="noAlign" value=""/>
            </section>
            <output name="output" ftype="bam">
                <assert_contents>
                    <has_size value="4200" delta="1000" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

@HELP@

The align subcommand is used to align reads against the indexed variation graphs. 

**Output**

The output alignment is essentially the ARG classified reads (which may be useful) and can then be used to report full-length ARGs (using the report subcommand)
    ]]></help>
    <expand macro="citations"/>
</tool>