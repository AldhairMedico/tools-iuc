<tool id="trimAl" name="trimAl" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="20.01" license="MIT">
    <description></description>
    <macros>
        <token name="@TOOL_VERSION@">1.5.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <edam_topics>
        <edam_topic>topic_3293</edam_topic> <!-- phylogenetics -->
        <edam_topic>topic_0080</edam_topic> <!-- sequence analysis -->
    </edam_topics>
    <edam_operations>
        <edam_operation>operation_3192</edam_operation> <!--sequence trimming -->
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">trimal</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">trimal</requirement>
    </requirements>
    <version_command>trimal --version</version_command>
    <command detect_errors="exit_code"><![CDATA[
trimal
-in '$inputfile'
-out '$outputfile'
$formatout

#if $trimming.trimtype == 'automated'
  $trimming.autotrim
#end if

#if $trimming.trimtype == 'overlaptrimming'
  $trimming.gaptrimming
  #if $trimming.resoverlap
    -resoverlap $trimming.resoverlap
  #end if
  #if $trimming.seqoverlap
    -seqoverlap $trimming.seqoverlap
  #end if
#end if

#if $trimming.trimtype == 'manual'
  #if $trimming.gapthreshold
  -gapthreshold $trimming.gapthreshold
  #end if
  #if $trimming.simthreshold
  -simthreshold $trimming.simthreshold
  #end if
  #if $trimming.conthreshold
  -conthreshold $trimming.conthreshold
  #end if
  #if $trimming.cons
  -cons $trimming.cons
  #end if
  #if $trimming.clusters
  -clusters $trimming.clusters
  #end if
  #if $trimming.maxidentity
  -maxidentity $trimming.maxidentity
  #end if
#end if

#unless $trimming.trimtype == 'notrimming'
  -htmlout '$htmlreport'
  -colnumbering
#end unless

    ]]></command>
    <inputs>
        <param argument="--inputfile" type="data" format="fasta" optional="false" label="Input multiple sequence alignment file" help=""/>
        <param name="formatout" type="select" multiple="false" label="Output format" help="">
            <option value="" selected="true">Same as input (default)</option>
            <option value="-nbrf">NBRF/PIR</option>
            <option value="-mega">MEGA</option>
            <option value="-nexus">NEXUS</option>
            <option value="-clustal">CLUSTAL</option>
            <option value="-fasta">FASTA</option>
            <option value="-fasta_m10">FASTA. Sequence name length up to 10 charachters.</option>
            <option value="-phylip">PHYLIP/PHYLIP4</option>
            <option value="-phylip_m10">PHYLIP/PHYLIP4.  Sequence name length up to 10 charachters.</option>
            <option value="-phylip_paml">PHYLIP format compatible with PAML</option>
            <option value="-phylip_paml_m10">PHYLIP format compatible with PAML. Sequence name length up to 10 charachters.</option>
            <option value="-phylip3.2">PHYLIP3.2</option>
            <option value="-phylip3.2_m10">PHYLIP3.2.Sequence name length up to 10 charachters.</option>
        </param>

        <conditional name="trimming">
            <param name="trimtype" type="select" label="Trimming Settings" help="Choose between several predefined trimming settings (automated), or set all thresholds yourself (manual)">
                <option value="automated" selected="true">Automated</option>
                <option value="manual">Manual</option>
                <option value="overlaptrimming">Overlap Trimming</option>
                <option value="notrimming">No trimming</option>
            </param>
            <when value="notrimming">
            </when>
            <when value="automated">
                <param name="autotrim" type="select" multiple="false" label="Select Automated trimming setting" help="gappyout: only uses information based on gaps’ distribution. strictplus: optimized for Neighbour Joining phylogenetic tree reconstruction. automated1: Use a heuristic selection of the automatic method based on similarity statistics, Optimized for Maximum Likelihood phylogenetic tree reconstruction.">
                    <option value="-gappyout">gappyout</option>
                    <option value="-strict">strict</option>
                    <option value="-strictplus">strict plus</option>
                    <option value="-automated1">automated1</option>
                </param>
            </when>
            <when value="overlaptrimming">
                <param name="gaptrimming" type="select" multiple="false" optional="true" label="gap-based trimming?" help="">
                    <option value="-nogaps">no gaps (Remove all positions with gaps in the alignment)</option>
                    <option value="-noallgaps">no all gaps (Remove columns composed only by gaps.)</option>
                </param>
                <param argument="-resoverlap" type="float" optional="true" min="0" max="1" label="Residue overlap" help="Minimum overlap of a positions with other positions in the column to be considered a “good position”. Range: [0-1]. Must be used in combination with Sequence overlap."/>
                <param argument="-seqoverlap" type="integer" optional="true" min="0" max="100" label="Sequence overlap" help="Minimum percentage of “good positions” that a sequence must have in order to be conserved. Range: [0-100]. Must be used in combination with Residue overlap."/>
            </when>

            <when value="manual">
                <param argument="-gapthreshold" type="float" optional="true" min="0" max="1" label="Gap Threshold. 1 - (fraction of gaps in the column)." help="Range: [0 - 1] Not compatible with -gat."/>
        <param argument="-simthreshold" type="float" optional="true" min="0" max="1"  label="Similarity Threshold. Minimum average similarity required." help="Range: [0 - 1]"/>
        <param argument="-conthreshold" type="float" optional="true" min="0" max="100" label="Consistency Threshold. Minimum consistency value required" help="Range: [0 - 1]. Not allowed in combination with inputfile."/>
        <param argument="-cons" type="integer" optional="true" min="0" max="100" label="Conservation. Minimum percentage of positions in the original alignment to conserve." help="Range: [0 - 100]"/>
        <param argument="-clusters" type="integer" optional="true" min="0" label="Clusters. Get the most Nth representatives sequences from a given alignment." help="Range:  [1 - (Number of sequences)]"/>
        <param argument="-maxidentity" type="float" optional="true" min="0" max="1" label="Max Identity. Get the representatives sequences for a given identity threshold. " help="Range: [0 - 1]"/>
            </when>
        </conditional>

    </inputs>
    <outputs>
        <data name="outputfile" format_source="inputfile" label="${tool.name} on ${on_string}: Optimized alignment ">
            <change_format>
                <when input="formatout" value="-nbrf" format="auto" />
                <when input="formatout" value="-mega" format="auto" />
                <when input="formatout" value="-nexus" format="auto" />
                <when input="formatout" value="-clustal" format="auto" />
                <when input="formatout" value="-fasta" format="fasta" />
                <when input="formatout" value="-fasta_m10" format="fasta" />
                <when input="formatout" value="-phylip" format="phylip" />
                <when input="formatout" value="-phylip_m10" format="phylip" />
                <when input="formatout" value="-pylip_paml" format="phylip" />
                <when input="formatout" value="-pylip_paml_m10" format="phylip" />
                <when input="formatout" value="-phylip3.2" format="phylip" />
                <when input="formatout" value="-phylip3.2_m10" format="phylip" />
            </change_format>
        </data>
        <data name="htmlreport" format="html" label="${tool.name} on ${on_string}: HTML report">
            <filter> trimming['trimtype'] != 'notrimming' </filter>
        </data>

    </outputs>
    <tests>
        <test expect_num_outputs="2"><!-- test a basic case -->
            <param name="inputfile" value="example.005.AA.fasta" ftype="fasta"/>
            <param name="trimtype" value="manual"/>
            <param name="gapthreshold" value="0.5"/>
            <output name="outputfile" file="example.005.AA.out.fasta" ftype="fasta" lines_diff="0"/>
            <output name="htmlreport" file="example.005.AA.report.html" ftype="html" lines_diff="0"/>
        </test>
        <test expect_num_outputs="2"><!-- test setting output format -->
            <param name="inputfile" value="example.005.AA.fasta" ftype="fasta"/>
            <param name="trimtype" value="manual"/>
            <param name="gapthreshold" value="0.5"/>
            <param name="formatout" value="-phylip"/>
            <output name="outputfile" file="example.005.AA.out.phylip" ftype="phylip" lines_diff="0"/>
            <output name="htmlreport" file="example.005.AA.report.html" ftype="html" lines_diff="0"/>
        </test>
        <test expect_num_outputs="2"><!-- test with an automated trimming method -->
            <param name="inputfile" value="example.005.AA.fasta" ftype="fasta"/>
            <param name="trimtype" value="automated"/>
            <param name="autotrim" value="gappyout"/>
            <output name="outputfile" file="example.005.AA.out.gappyout.fasta" ftype="fasta" lines_diff="0"/>
            <output name="htmlreport" file="example.005.AA.report.gappyout.html" ftype="html" lines_diff="0"/>
        </test>
        <test expect_num_outputs="1"><!-- test with no trimming -->
            <param name="inputfile" value="example.005.AA.fasta" ftype="fasta"/>
            <param name="trimtype" value="notrimming"/>
            <output name="outputfile" file="example.005.AA.out.notrim.fasta" ftype="fasta" lines_diff="0"/>
        </test>
        <test expect_num_outputs="2"><!-- test with overlap trimming -->
            <param name="inputfile" value="example.005.AA.fasta" ftype="fasta"/>
            <param name="trimtype" value="overlaptrimming"/>
            <param name="gaptrimming" value="-nogaps"/>
            <param name="resoverlap" value="0.8"/>
            <param name="seqoverlap" value="6"/>
            <output name="outputfile" file="example.005.AA.out.overlaptrim.fasta" ftype="fasta" lines_diff="0"/>
            <output name="htmlreport" file="example.005.AA.report.overlaptrim.html" ftype="html" lines_diff="0"/>
        </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

**What it does**

trimAl is a tool for the automated removal of spurious sequences or poorly aligned regions from a multiple sequence alignment.

trimAl can consider several parameters, alone or in multiple combinations, in order to select the most-reliable positions in the alignment. These include the proportion of sequences with a gap, the level of residue similarity and, if several alignments for the same set of sequences are provided, the consistency level of columns among alignments. Moreover, trimAl allows to manually select a set of columns and sequences to be removed from the alignment.

trimAl implements a series of automated algorithms that trim the alignment searching for optimum thresholds based on inherent characteristics of the input alignment, to be used so that the signal-to-noise ratio after alignment trimming phase is increased.

Among trimAl’s additional features, trimAl allows getting the complementary alignment (columns that were trimmed), to compute statistics from the alignment, to select the output file format , to get a summary of trimAl’s trimming in HTML and SVG formats, and many other options.


**Input**

A multiple sequence alignment file. Available input formats: clustal, fasta, nexus, phylip32, phylip40, pir

**Output**

Optimized alignment. By default in the same format as input file, unless explicitly set by user.

**Trimming Settings**

For a detailed description of the automated, see the Trimal `user guide`_ (trimming section).

.. _user guide: https://trimal.readthedocs.io/en/latest/algorithms.html#automated-methods
    ]]></help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/btp348</citation>
    </citations>
</tool>
