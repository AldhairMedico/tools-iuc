<macros>
    <token name="@TOOL_VERSION@">5.0</token>
    <token name="@VERSION_SUFFIX@">0</token>
    <token name="@PROFILE@">23.0</token>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">r-seurat</requirement>
        </requirements>
    </xml>
    <xml name="citations">
        <citations>
            <citation type="doi">10.1038/s41587-023-01767-y</citation>
        </citations>
    </xml>
    <xml name="sanitize_query" token_validinitial="string.printable">
        <sanitizer>
            <valid initial="@VALIDINITIAL@">
                <remove value="&apos;" />
            </valid>
       </sanitizer>
    </xml>
    <xml name="sanitize_vectors" token_validinitial="string.digits">
        <sanitizer>
            <valid initial="@VALIDINITIAL@">
                <add value=","/>
            </valid>
        </sanitizer>
    </xml>
    <xml name="version_command">
        <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", Seurat version" $(R --vanilla --slave -e "library(Seurat); cat(sessionInfo()\$otherPkgs\$DESeq2\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
        ]]></version_command>
    </xml>

    <token name="@CMD_imports@"><![CDATA[
library(Seurat)
    ]]>
    </token>
    <xml name="input_rds">
        <param name="seurat_rds" type="data" format="rds" label="RDS input file with the Seurat object"/>
    </xml>
    <token name="@CMD_read_inputs@"><![CDATA[
seurat_obj = readRDS('seurat.rds')
        ]]>
    </token>
    <token name="@CMD@"><![CDATA[
cp '$seurat_rds' 'seurat.rds' &&
cat '$script_file' > '$hidden_output' &&
Rscript '$script_file' >> '$hidden_output' &&
ls . >> '$hidden_output'
    ]]>
    </token>
    <xml name="inputs_common_advanced">
        <section name="advanced_common" title="Advanced Options" expanded="false">
            <param name="show_log" type="boolean" checked="false" label="Output Log?" />
        </section>
    </xml>
    <xml name="outputs_common_advanced">
        <data name="hidden_output" format="txt" label="Log file" >
            <filter>advanced_common['show_log']</filter>
        </data>
    </xml>
    <xml name="seurat_outputs">
        <data name="rds_out" format="rds" from_work_dir="seurat.rds" label="${tool.name} (${method.method}) on ${on_string}: RDS"/>
        <expand macro="outputs_common_advanced"/>
    </xml>
    <token name="@CMD_rds_write_outputs@"><![CDATA[
saveRDS(seurat_obj, 'seurat.rds')
        ]]>
    </token>
    <xml name="markers_out">
        <data name="markers_tabular" format="tabular" from_work_dir="markers_out.csv" label="${tool.name} on ${on_string}: Markers list">
            <filter>method['method'] != 'FindNeighbors' and method['method'] != 'FindClusters'</filter>
        </data>
    </xml>
    <token name="@CMD_write_markers_tab@"><![CDATA[
write.csv(seurat_markers, 'markers_out.csv')
    ]]>]
    </token>
    <xml name="param_eps" tokens="eps_value">
        <param argument="eps" type="float" value="@EPS_VALUE@"  label="Small number to avoid numerical errors"/>
    </xml>
</macros>
