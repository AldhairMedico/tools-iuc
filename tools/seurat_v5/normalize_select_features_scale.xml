<tool id="seurat_preprocessing" name="Seurat Preprocessing" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>- Normalize, Scale and Regress</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
@CMD@
    ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

#if $method.method == 'NormalizeData'
seurat_obj<-NormalizeData(
    seurat_obj,
    #if $method.assay != ''
    assay = '$method.assay',
    #end if
    normalization.method = '$method.normalization_method.normalization_method',
    #if $method.normalization_method.normalization_method == 'CLR'
    margin = $method.normalization_method.margin,
    #end if
    scale.factor = $method.scale_factor,
    #if $method.block_size
    block.size = $method.block_size
    #end if
)

#else if $method.method == 'FindVariableFeatures'
seurat_obj<-FindVariableFeatures(
    seurat_obj,
    selection.method = '$method.selection_method.selection_method',
    #if $method.selection_method.selection_method == 'vst'
    loess.span = $method.selection_method.loess_span,
        #if $method.selection_method.clip_max
        clip.max = $method.selection_method.clip_max,
        #end if
        #if $method.selection_method.nfeatures
        nfeatures = $method.selection_method.nfeatures,
        #end if
    #else if $method.selection_method.selection_method == 'dispersion'
        #if $method.selection_method.nfeatures
        nfeatures = $method.selection_method.nfeatures,
        #end if
    #end if
    num.bin = $method.num_bin,
    binning.method = '$method.binning_method'
)

    #if $method.output_topN.output_topN == 'true'
    N = $method.output_topN.topN
    top_N<-head(VariableFeatures(seurat_obj), N)
    @CMD_write_variable_tab@
    #end if

#else if $method.method == 'ScaleData'

all.genes<-rownames(seurat_obj)

seurat_obj<-ScaleData(
    seurat_obj,
    #if $method.features != ''
        #if $method.features == 'all.genes'
        features = all.genes,
        #else
        features = c(unlist(strsplit(gsub(" ", "", '$method.features'), ",")),
        #end if
    #end if
    #if $method.assay != ''
    assay = '$method.assay',
    #end if
    #if $method.regress.regress == 'true'
    vars.to.regress = c(unlist(strsplit(gsub(" ", "", '$method.regress.vars_to_regress'), ","))),
    model.use = '$method.regress.model_use',
    use.umi = $method.regress.use_umi,
    #end if
    #if $method.split_by != ''
    split.by = '$method.split_by',
    #end if
    do.scale = $method.do_scale,
    do.center = $method.do_center,
    #if $method.do_scale == 'true'
    scale.max = $method.scale_max,
    block.size = $method.block_size,
    min.cells.to.block = $method.min_cells_to_block
    #end if
)
#end if

@CMD_rds_write_outputs@

]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="input_rds"/>
        <conditional name="method">
            <param name="method" type="select" label="Method used">
                <option value="NormalizeData">Normalize with 'NormalizeData'</option>
                <option value="FindVariableFeatures">Identify highly variable genes with 'FindVariableFeatures'</option>
                <option value="ScaleData">Scale and regress with 'ScaleData'</option>
            </param>
            <when value="NormalizeData">
                <expand macro="select_assay"/>
                <conditional name="normalization_method">
                    <param name="normalization_method" type="select" label="Method for normalization" help="(--normalization.method)">
                        <option value="LogNormalize" selected="true">LogNormalize</option>
                        <option value="CLR">CLR</option>
                        <option value="RC">RC</option>
                    </param>
                    <when value="LogNormalize"></when>
                    <when value="CLR">
                        <param name="margin" type="select" checked="true" label="Normalize across features (1) or cells (2)" help="(--margin)">
                            <option value="1" selected="true">features</option>
                            <option value="2">cells</option>
                        </param>
                    </when>
                    <when value="RC"></when>
                </conditional>
                <param name="scale_factor" type="integer" value="10000" label="Set scale factor for normalization" help="(--scale.factor)"/>
                <param name="block_size" type="integer" optional="true" value="" label="Number of cells to run in each block" help="(--block.size)"/>
            </when>
            <when value="FindVariableFeatures">
                <conditional name="selection_method">
                    <param name="selection_method" type="select" label="Method to select variable features" help="(--selection.method)">
                        <option value="vst" selected="true">vst</option>
                        <option value="mean.var.plot">mean.var.plot</option>
                        <option value="dispersion">dispersion</option>
                    </param>
                    <when value="vst">
                        <param name="loess_span" type="float" value="0.3" label="Loess span parameter for fitting variance-mean relationship" help="(--loess.span)"/>
                        <param name="clip_max" type="float" optional="true" value="" label="Maximum value after standardisation" help="leave blank to use default, the square root of number of cells (--clip.max)"/>
                        <param name="nfeatures" type="integer" optional="true" value="2000" label="Number of features to select as top variable features" help="(--nfeatures)"/>
                    </when>
                    <when value="mean.var.plot"></when>
                    <when value="dispersion">
                        <param name="nfeatures" type="integer" optional="true" value="2000" label="Number of features to select as top variable features" help="(--nfeatures)"/>
                    </when>
                </conditional>
                <param name="num_bin" type="integer" value="20" label="Number of bins to use" help="(--num.bin)"/>
                <param name="binning_method" type="select" label="Method to compute bins" help="(--binning.method)">
                    <option value="equal_width" selected="true">equal width</option>
                    <option value="equal_frequency">equal frequency</option>
                </param>
                <conditional name="output_topN">
                    <param name="output_topN" type="select" label="Output list of most variable features">
                        <option value="true">Yes</option>
                        <option value="false" selected="true">No</option>
                    </param>
                    <when value="true">
                        <expand macro="set_topN"/>
                    </when>
                    <when value="false">
                    </when>
                </conditional>
            </when>
            <when value="ScaleData">
                <expand macro="select_assay"/>
                <conditional name="regress">
                    <param name="regress" type="select" label="Regress out a variable or latent data">
                        <option value="true">Yes</option>
                        <option value="false" selected="true">No</option>
                    </param>
                    <when value="true">
                        <param name="vars_to_regress" type="text" optional="true" value="" label="Variable(s) to regress out" help=" comma-separated list e.g. percent.mt, nUMI (--vars.to.regress)"/>
                        <param name="model_use" type="select" optional="true" label="Model to use for regression" help="(--model.use)">
                            <option value="linear" selected="true">linear</option>
                            <option value="poisson">poisson</option>
                            <option value="negbinom">negbinom</option>
                        </param>
                        <param name="use_umi" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Regress on UMI count data" help="recommended if regression model is not linear (--use.umi)"/>
                    </when>
                    <when value="false">
                    </when>
                </conditional>
                <param name="features" type="text" optional="true" value="" label="Features to scale" help="default is variable features, use all.genes to scale all or a comma-separated list of features (--features)"/>
                <param name="split_by" type="text" optional="true" value="" label="Scale cells in groups by a variable, vector or factor" help="(--split.by)"/>
                <param name="do_scale" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Scale the data" help="(--do.scale)"/>
                <param name="do_center" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Center the data" help="(--do.center)"/>
                <param name="scale_max" type="float" value="10" label="Set max value for scaled data" help="(--scale.max)"/>
                <param name="block_size" type="integer" value="1000" label="Number of features to scale in a single computation" help="(--block.size)"/>
                <param name="min_cells_to_block" type="integer" value="3000" label="Use blocks for scaling if object has more than this number of cells" help="(--min.cells.to.block)"/>
            </when>
        </conditional>
        <expand macro="inputs_common_advanced"/>
    </inputs>
    <outputs>
        <expand macro="seurat_outputs"/>
        <expand macro="variable_out"/>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <!-- test1: NormalizeData -->
            <param name="seurat_rds" location="https://zenodo.org/records/12743815/files/filtered.rds"/>
            <conditional name="method">
                <param name="method" value="NormalizeData"/>
                <conditional name="normalization_method">
                    <param name="normalization_method" value="LogNormalize"/>
                </conditional>
                <param name="scale_factor" value="10000"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="NormalizeData"/>
                </assert_contents>
            </output>
            <output name="rds_out" location="https://zenodo.org/records/12743815/files/normalized.rds" ftype="rds" compare="sim_size">
            </output>
        </test>
        <test expect_num_outputs="3">
            <!-- test2: FindVariableFeatures -->
            <param name="seurat_rds" location="https://zenodo.org/records/12743815/files/normalized.rds"/>
            <conditional name="method">
                <param name="method" value="FindVariableFeatures"/>
                <conditional name="selection_method">
                    <param name="selection_method" value="vst"/>
                    <param name="loess_span" value="0.3"/>
                    <param name="nfeatures" value="100"/>
                </conditional>
                <param name="num_bin" value="20"/>
                <param name="binning_method" value="equal_width"/>
                <conditional name="output_topN">
                    <param name="output_topN" value="true"/>
                    <param name="topN" value="10"/>
                </conditional>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="FindVariableFeatures"/>
                </assert_contents>
            </output>
            <output name="rds_out" location="https://zenodo.org/records/12743815/files/variablefeatures.rds" ftype="rds" compare="sim_size">
            </output>
            <output name="variable_tabular" location="https://zenodo.org/records/12743815/files/variable_top10.txt" ftype="txt"/>
        </test>
        <test expect_num_outputs="2">
            <!-- test3: ScaleData -->
            <param name="seurat_rds" location="https://zenodo.org/records/12743815/files/variablefeatures.rds"/>
            <conditional name="method">
                <param name="method" value="ScaleData"/>
                <conditional name="regress">
                    <param name="regress" value="YesRegress"/>
                    <param name="vars_to_regress" value="nUMI"/>
                    <param name="model_use" value="linear"/>
                    <param name="use_umi" value="FALSE"/>
                </conditional>
                <param name="features" value="all.genes"/>
                <param name="do_scale" value="TRUE"/>
                <param name="do_center" value="TRUE"/>
                <param name="scale_max" value="10"/>
                <param name="block_size" value="1000"/>
                <param name="min_cells_to_block" value="3000"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="ScaleData"/>
                </assert_contents>
            </output>
            <output name="rds_out" location="https://zenodo.org/records/12743815/files/scaled.rds" ftype="rds" compare="sim_size">
            </output>
        </test>
    </tests>
    <help><![CDATA[
Seurat
======

Seurat is an R package designed for QC, analysis, and exploration of single-cell RNA-seq data. 

Seurat aims to enable users to identify and interpret sources of heterogeneity from single-cell transcriptomic measurements, and to integrate diverse types of single-cell data.

NormalizeData
=============

Normalize the count data present in a given assay.

Methods:

“LogNormalize”: Feature counts for each cell are divided by the total counts for that cell and multiplied by the scale.factor. This is then natural-log transformed using log1p

“CLR”: Applies a centered log ratio transformation

“RC”: Relative counts. Feature counts for each cell are divided by the total counts for that cell and multiplied by the scale.factor. No log-transformation is applied. For counts per million (CPM) set scale.factor = 1e6


More details on the `seurat documentation
<https://satijalab.org/seurat/reference/normalizedata>`__

FindVariableFeatures
====================

Identify features that are outliers on a 'mean variability plot'.

Methods:

“vst”: First, fits a line to the relationship of log(variance) and log(mean) using local polynomial regression (loess). Then standardizes the feature values using the observed mean and expected variance (given by the fitted line). Feature variance is then calculated on the standardized values after clipping to a maximum (see clip.max parameter).

“mean.var.plot” (mvp): First, uses a function to calculate average expression (mean.function, using FastExpMean) and dispersion (dispersion.function, using FastLogVMR) for each feature. Next, divides features into num.bin (deafult 20) bins based on their average expression, and calculates z-scores for dispersion within each bin. The purpose of this is to identify variable features while controlling for the strong relationship between variability and average expression

“dispersion” (disp): selects the genes with the highest dispersion values

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/findvariablefeatures>`__

Scale and regress the data with ScaleData
=========================================

Scale and center features in the dataset. 

If variables are provided in vars.to.regress, they are individually regressed against each feature, and the resulting residuals are then scaled and centered.

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/scaledata>`__

    ]]></help>
    <expand macro="citations"/>
</tool>