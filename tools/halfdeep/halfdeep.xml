<tool id="halfdeep" name="HalfDeep" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>identifies genomic regions with half-depth coverage based on sqeuencing read mappings. These regions may reveal insights into heterogametic sex chromosomes, haplotype-specific variation, or potential assembly errors such as heterotypic duplications.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        #import os
        ##
        ## reference
        ##
        ln -s '$ref' 'ref.$ref.ext' &&
        touch ref.idx &&
        ##
        ## reads
        ##
        #set $reads_dir = "reads"
        #set $mapped_reads_dir = "halfdeep/ref/mapped_reads"
        mkdir -p '$reads_dir' '$mapped_reads_dir' &&
        #for $read in $reads
            #set $seq_base = os.path.basename(str($read))
            ln -s '$read' '$reads_dir/$seq_base' &&
            echo '$reads_dir/$seq_base' >> input.fofn &&
            ##
            ## mapped reads
            ##
            #for $mapped_read in $mapped_reads
                ln -s '$mapped_read' "$mapped_reads_dir/${seq_base}.bam" &&
                ln -s "${seq_base}.bam" "$mapped_reads_dir/${seq_base}.sort.bam" &&
                ln -s '$mapped_read.metadata.bam_index' "$mapped_reads_dir/${seq_base}.sort.bam.bai" &&
            #end for
        #end for
        ##
        ## run bam_depth.sh
        ##
        #for $line_number in range(1, len($reads) + 1)
            bam_depth.sh 'ref.$ref.ext' $line_number &&
        #end for
        ##
        ## run halfdeep.sh
        ##
        halfdeep.sh 'ref.$ref.ext'
    ]]></command>
    <inputs>
        <param name="ref" type="data" format="fasta,fasta.gz" label="Genome Assembly" help="A Genome Assembly in FASTA format."/>
        <param name="reads" type="data" format="fastqsanger,fastqsanger.gz" multiple="true" label="Sequencing Reads" help="Sequencing Reads for the Genome Assembly in FASTQ format."/>
        <param name="mapped_reads" type="data" format="bam" multiple="true" label="Aligned Reads" help="Alignments of the Sequencing Reads to the Genome Assembly in BAM format."/>
    </inputs>
    <outputs>
        <data name="scaffold_len" format="tabular" from_work_dir="halfdeep/ref/scaffold_lengths.dat" label="Scaffold lengths for ${on_string}"/>
        <data name="depth_dat" format="tabular.gz" from_work_dir="halfdeep/ref/depth.dat.gz" label="Depth for ${on_string}"/>
        <data name="pct_cmds" format="text" from_work_dir="halfdeep/ref/percentile_commands.sh" label="Percentile to value for ${on_string}"/>
        <data name="halfdeep_dat" format="bed" from_work_dir="halfdeep/ref/halfdeep.dat" label="HalfDeep on ${on_string}"/>
    </outputs>
    <tests>
        <test expect_num_outputs="4">
            <param name="ref" value="ref.fasta.gz" ftype="fasta.gz"/>
            <param name="reads" value="reads.fasta.gz" ftype="fasta.gz"/>
            <param name="mapped_reads" value="mapped_reads.bam" ftype="bam"/>
            <output name="scaffold_len" file="scaffold_lengths.tabular" ftype="tabular"/>
            <output name="depth_dat" file="depth.tabular.gz" ftype="tabular.gz"/>
            <output name="pct_cmds" file="percentile.txt" ftype="text"/>
            <output name="halfdeep_dat" file="halfdeep.bed" ftype="bed"/>
        </test>
    </tests>
    <help><![CDATA[
HalfDeep requires the following inputs:

1. A genome assembly in FASTA format.

2. Reads in FASTQ format.

3. Mapped reads in BAM format


HalfDeep automates the following tasks:

1. Mapping reads and merging individual mapping files.

2. Calculating per-base read depth.

3. Smoothing read coverage using a defined window with genodsp.

4. Determining the percentile of read coverage.

5. Identifying genomic regions with half-depth coverage based on a specified percentile threshold (e.g., 40â€“60%) and exporting them in BED file forma

HalfDeep produces the following outputs:

1. Scaffold lengths: A tabular file containing the name and legth of each sequence in the genome assembly.

2. Depths: A tabular file containing the read depts.

3. A tabular file containing the name and legth of each sequence in the genome assembly: stuff

4. HalfDeep: BED file containina regions of the genome assembly that are "covered at half depth"
    ]]></help>
    <expand macro="citations"/>
</tool>
