<tool id="modify_loom" name="Loom operations" version="@TOOL_VERSION@+galaxy1">
    <description>Manipulate, export loom files and import from anndata</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
        <requirement type="package" version="3.0.6">loompy</requirement>
        <requirement type="package" version="1.26.4">numpy</requirement>
    </expand>

    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[

#if operation.to_perfom' == 'manipulate'
cp '${operation.loom}' loom_add_out.loom &&
python '$__tool_directory__/modify_loom.py' -f 'loom_add_out.loom'
    #if $operation.which_add.add_type == "cols":
    -a cols -c '${operation.which_add.cols}'
    #else if $operation.which_add.add_type == "cols":
    -a rows -r '${operation.which_add.rows}'
    #else if $operation.which_add.add_type == "layers":
    -a layers -l '${operation.which_add.layers}'
    #end if

#else if operation.to_perfom' == 'export'
mkdir ./output &&
mkdir ./attributes &&
python '$__tool_directory__/loompy_to_tsv.py' -f '$operation.loom'

#else if operation.to_perfom' == 'import'
adata = ad.read_h5ad('$operation.anndata')
adata.write_loom('anndata.loom')

#end if
      ]]></command>
    <inputs>
        <conditional name="operation">
            <param name="to_perform" type="select" label="Operation to perform on loom data">
                <option value="manipulate">Manipulate loom data</option>
                <option value="export">Export loom layers and attributes</option>
                <option value="import">Import loom from an anndata</option>
            </param>
            <when value="manipulate">
                <conditional name="which_add">
                    <param name="loom" type="data" format="loom" label="Loom file"/>
                    <param name="add_type" type="select" label="Select data attribute to add to loom">
                        <option value="cols">Columns</option>
                        <option value="rows">Rows</option>
                        <option value="layers">Layers</option>
                    </param>
                    <when value="cols">
                        <param name="cols" type="data" format="tabular" label="Column file of same dimensions as existing file"/>
                    </when>
                    <when value="rows">
                        <param name="rows" type="data" format="tabular" label="Row file of same dimensions as existing file"/>
                    </when>
                    <when value="layers">
                        <param name="layers" type="data" multiple="true" format="tabular" label="Layer file(s) of same dimensions as existing file"/>
                    </when>
                </conditional>
            </when>
            <when value="export">
                <param name="loom" type="data" format="loom" label="Loom file"/>
            </when>
            <when value="import">
                <param name="anndata" type="data" format="h5ad" label="Anndata file"/>
            </when>
    </inputs>
    <outputs>
        <data name="loomout" format="loom" from_work_dir='loom_add_out.loom' label="Expanded loom file from '${on_string}'">
            <filter>operation['to_perfom'] == 'manipulate'</filter>
        </data>
        <collection name="layer_tsvs" type="list" label="Layer matrices" >
            <filter>operation['to_perfom'] == 'export'</filter>
            <discover_datasets pattern="__designation__" format="tabular" directory="output" visible="false" />
        </collection>
        <collection name="attribute_tsvs" type="list" label="Attribute matrices" >
            <filter>operation['to_perfom'] == 'export'</filter>
            <discover_datasets pattern="__designation__" format="tabular" directory="attributes" visible="false" />
        </collection>
        <data name="loomout" format="loom" from_work_dir="anndata.loom" label="${tool.name} on ${on_string}: Loom file from Anndata">
            <filter>operation['to_perfom'] == 'import'</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="to_perform" value="manipulate">
                <param name="loom" value="addtest.loom"/>
                <param name="add_type" value="cols"/>
                <param name="cols" value="cols.tsv"/>
            </conditional>
            <output name="loomout" value="addloomout1.loom" ftype="loom" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="to_perform" value="manipulate">
                <param name="loom" value="addtest.loom"/>
                <param name="add_type" value="rows"/>
                <param name="rows" value="rows.tsv"/>
            </conditional>
            <output name="loomout" value="addloomout2.loom" ftype="loom" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="to_perform" value="manipulate">
                <param name="loom" value="addtest.loom"/>
                <param name="add_type" value="layers"/>
                <param name="layers" value="addlayer1.tsv"/>
            </conditional>
            <output name="loomout" value="addloomout3.loom" ftype="loom" compare="sim_size"/>
        </test>
        <test expect_num_outputs="2">
            <conditional name="operation">
                <param name="to_perform" value="export">
                <param name="loom" value="loomtest.loom"/>
            </conditional>
            <output_collection name="layer_tsvs" type="list">
                <element name="mainmatrix.tsv" value="firstlayer.tsv" ftype="tabular"/>
                <element name="extralayer.tsv" value="secondlayer.tsv" ftype="tabular"/>
                <element name="thirdlayer.tsv" value="finallayer.tsv" ftype="tabular"/>
            </output_collection>
            <output_collection name="attribute_tsvs" type="list">
                <element name="row_attr.tsv" value="rows.tsv" ftype="tabular"/>
                <element name="col_attr.tsv" value="cols.tsv" ftype="tabular"/>
            </output_collection>
        </test>
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="to_perform" value="export">
                <param name="anndata" value="krumsiek11.h5ad"/>
                <param name="output_format" value="loom"/>
            </conditional>
            <assert_stdout>
                <has_text_matching expression="adata.write_loom"/>
            </assert_stdout>
            <output name="loomout" value="export.krumsiek11.loom" ftype="loom" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
This tool allows the user to modify an existing loom data file by adding column attributes, row attributes or additional layers via tsv files.
    ]]></help>
    <citations>
        <citation type="bibtex">@UNPUBLISHED{Linnarsson2016,
            author = "Linnarsson lab"
            title = "Loompy"
            year = "2013"
            note = "https://github.com/linnarsson-lab/loompy"}
        </citation>
    </citations>
</tool>
