<tool id="decontam" name="Decontam" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$rscript'
    ]]></command>
    <configfiles>
        <configfile name="rscript"><![CDATA[
            library(tidyverse)
            library(phyloseq)
            library(ggplot2)
            library(decontam)

            ## get OTU table (first column is the OTU/ASV ID)
            otu <- read_tsv("$otu")
            otu2 <- otu %>% tibble::column_to_rownames(colnames(otu)[1]) #use first column as colname
            OTU <- otu_table(otu2,  taxa_are_rows = FALSE)

            ## get metadata table must have matching OTU/ASV ID in first column
            meta <- read_tsv("$metadata")
            meta2 <- meta %>% tibble::column_to_rownames(colnames(meta)[1]) #use first column as colname

            control_column = as.integer("$control") - 1

            ## convert 0/1 to bool for the control column and store in control column
            meta2\$control <- as.logical(meta2[[control_column]])
            sampledata <- sample_data(meta2)

            ps <- phyloseq(OTU, FALSE, sampledata)

            df <- as.data.frame(sample_data(ps)) # Put sample_data into a ggplot-friendly data.frame
            df\$LibrarySize <- sample_sums(ps)
            df <- df[order(df\$LibrarySize),]
            df\$Index <- seq(nrow(df))
            ggplot(data=df, aes(x=Index, y=LibrarySize, color=control)) + geom_point()
            ggsave("$library_size_vs_control", device = "png", width = 12, height = 12, units = "cm")

        ]]></configfile>
    </configfiles>
    <inputs>
        <param name="otu" type="data" format="tabular" label="Feature table" help="OTU/ASV or other feature table. The first column must have corresponding IDs to the metadata table." />
        <param name="metadata" type="data" format="tabular" label="Metadata" help="Metadata that contains a column specifying weather a samples is a negativ control (0 for normal samples / 1 for control). The first column must have corresponding IDs to the feature table." />
        <param name="control" type="data_column" data_ref="metadata" use_header_names="true" multiple="false" optional="false" label="Control column" help="Column specifying weather a samples is a negativ control (0 for normal samples / 1 for control)" />
    </inputs>
    <outputs>
        <data name="library_size_vs_control" format="png"/>
    </outputs>
    <help><![CDATA[
    TODO: Fill in help.
    ]]></help>
</tool>